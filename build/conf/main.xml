<!--
This file is part of muCommander, http://www.mucommander.com
Copyright (C) 2002-2007 Maxence Bernard

muCommander is free software; you can redistribute it and/or modify
it under the terms of the GNU Lesser General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

muCommander is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Lesser General Public License for more details.

You should have received a copy of the GNU Lesser General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<!-- ========================================================= -->
<!-- Declares Configuration API specific properties and        -->
<!-- targets.                                                  -->
<!-- ========================================================= -->
<project>
  <!-- = Application constants =============================== -->
  <!-- ======================================================= -->
  <!-- The following properties describe the current version   -->
  <!-- of the muCommander conf API.                            -->

  <!-- Major version of the muCommander conf API.              -->
  <property name="conf.version"        value="1.0"/>
  <!-- Minor version of the muCommander conf API.              -->
  <property name="conf.subversion"     value=".0"/>
  <patternset id="conf.sources">
    <exclude name="com/mucommander/conf/impl/**"/>
    <include name="com/mucommander/conf/**"/>
    <include name="com/mucommander/xml/**"/>
  </patternset>



  <!-- = Conf API compilation ================================ -->
  <!-- ======================================================= -->
  <!-- The following tasks are used to compile the muCommander -->
  <!-- conf API.                                               -->

  <!-- Compiles the conf source code.                          -->
  <!-- Compiled sources will be stored in                      -->
  <!-- ${conf.classes.normal}.                                 -->
  <target name="conf-compile">
    <echo>Compiling Configuration API...</echo>
    <delete dir="${conf.classes.normal}"/>
    <mkdir dir="${conf.classes.normal}"/>
    <javac destdir="${conf.classes.normal}" debug="on" deprecation="on"
           encoding="utf-8" source="1.4" target="1.4" srcdir="${source}">
      <classpath>
         <fileset dir="${lib}/">
           <include name="*include/*.jar"/>
         </fileset>
      </classpath>
      <patternset refid="conf.sources"/>
    </javac>
  </target>

  <!-- Creates a JAR file containing the uncompressed,         -->
  <!-- unobfuscated conf bytecode.                             -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.normal}.                                     -->
  <target name="conf-jar" depends="conf-compile">
    <echo>Creating Configuration API JAR file...</echo>
    <copy file="${conf.license}" todir="${conf.classes.normal}" overwrite="true"/>
    <jar destfile="${conf.jar.normal}" basedir="${conf.classes.normal}" excludes="**/*Test.class">
      <manifest>
        <attribute name="Specification-Title"    value="muCommander Configuration API"/>
        <attribute name="Specification-Vendor"   value="Maxence Bernard"/>
        <attribute name="Specification-Version"  value="${conf.version}"/>
        <attribute name="Implementation-Title"   value="muCommander Configuration API"/>
        <attribute name="Implementation-Vendor"  value="Maxence Bernard"/>
        <attribute name="Implementation-Version" value="${conf.version}${conf.subversion}"/>
      </manifest>
    </jar>
  </target>



  <!-- = Configuration API obfuscation ======================= -->
  <!-- ======================================================= -->
  <!-- The following targets are used to obfuscate the         -->
  <!-- muCommander conf API when possible.                     -->

  <!-- Copies the uncompressed, unobfuscated conf JAR file     -->
  <!-- over the obfuscated one.                                -->
  <!-- This target is only meant to be used when proGuard is   -->
  <!-- not available.                                          -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.obf}.                                        -->
  <target name="conf-copy-bytecode" unless="proguard.available">
    <echo>proGuard unavailable, skipping obfuscation of the Configuration API...</echo>
    <copy file="${conf.jar.normal}" tofile="${conf.jar.obf}" overwrite="true"/>
  </target>

  <!-- Obfuscated the uncompressed, unobfuscated conf JAR      -->
  <!-- file.                                                   -->
  <!-- This target is only meant to be used when proGuard is   -->
  <!-- available.                                              -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.obf}.                                        -->
  <target name="conf-obfuscate-bytecode" depends="conf-load-libpath" if="proguard.available">
    <echo>Creating Configuration API obfuscated JAR file...</echo>
    <mkdir dir="${conf.reports}"/>
    <proguard overloadaggressively="false" usemixedcaseclassnames="${case-sensitive-fs}" ignorewarnings="true" optimize="true" shrink="true" obfuscate="true"
              allowaccessmodification="false" repackageclasses="" skipnonpubliclibraryclasses="false" printusage="${conf.proguard.reports}">
      <injar name="${conf.jar.normal}"/> 
      <outjar name="${conf.jar.obf}"/>
      <libraryjar name="${java.lib}"/>
      <libraryjar name="${lib}/noinclude" jarfilter="*.jar"/>
      <keepattribute name="exceptions"/>

      <keep access="public">
        <field access="public,protected"/>
        <method access="public,protected"/>
        <constructor access="public,protected"/>
      </keep>
    </proguard>
  </target>

  <!-- Identifies the best available obfuscation policy and    -->
  <!-- obfuscates the conf JAR file.                           -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.obf}.                                        -->
  <target name="conf-obfuscate" depends="conf-jar,load-proguard,conf-copy-bytecode,conf-obfuscate-bytecode"/>



  <!-- = Conf API compression ================================ -->
  <!-- ======================================================= -->
  <!-- The following targets are used to compress the          -->
  <!-- muCommander conf API when possible.                     -->

  <!-- Compress the obfuscated conf JAR file using 7za.        -->
  <!-- This target is only meant to be called if 7za is        -->
  <!-- available.                                              -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.cmp}.                                        -->
  <target name="conf-compress-obfuscated" if="7za.available">
    <echo>Compressing the Configuration API...</echo>
    <delete dir="${conf.classes.obf}"/>
    <unjar src="${conf.jar.obf}" dest="${conf.classes.obf}"/>
    <exec executable="${7za.executable}" dir="${conf.classes.obf}">
      <arg value="a"/>
      <arg value="-tzip"/>
      <arg value="-mm=Deflate"/>
      <arg value="-mx9"/>
      <arg value="-mfb=258"/>
      <arg value="-mpass=15"/>
      <arg value="${conf.jar.cmp}"/>
      <arg value="*"/>
    </exec>
  </target>

  <!-- Compress the obfuscated conf JAR file using standard    -->
  <!-- zip compression.                                        -->
  <!-- This target is only meant to be called if 7za is not    -->
  <!-- available.                                              -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.cmp}.                                        -->
  <target name="conf-copy-obfuscated" unless="7za.available">
    <echo>7za unavailable, using standard compression for the Configuration API...</echo>
    <copy file="${conf.jar.obf}" tofile="${conf.jar.cmp}"/>
  </target>

  <!-- Identifies the best available compression policy and    -->
  <!-- compresses the conf JAR obfuscated file.                -->
  <!-- The resulting JAR file will be stored in                -->
  <!-- ${conf.jar.cmp}.                                        -->
  <target name="conf-compress" depends="check-7za,conf-obfuscate,conf-compress-obfuscated,conf-copy-obfuscated"/>



  <!-- = Reports generation ================================== -->
  <!-- ======================================================= -->
  <target name="conf-reports" depends="clean,conf-obfuscate,conf-unit-test,conf-findbugs,conf-similarity-test"/>



  <!-- = Simian integration (similarity checker) ============= -->
  <!-- ======================================================= -->

  <!-- Notifies user that unit tests are being skipped if      -->
  <!-- junit is not available.                                 -->
  <target name="conf-skip-similarity-test" unless="simian.available">
    <echo>Simian not available, skipping Configuration API similarity check...</echo>
  </target>

  <!-- Run similarity test                                     -->
  <target name="conf-do-similarity-test" depends="load-simian" if="simian.available">
    <echo>Running Configuration API similarity check...</echo>
    <mkdir dir="${conf.reports}"/>
    <simian>
      <fileset dir="${source}">
        <patternset refid="conf.sources"/>
      </fileset>
      <formatter type="plain" toFile="${conf.simian.reports}"/>
    </simian>
  </target>

  <!-- Runs similarity test only if Simian is available.       -->
  <target name="conf-similarity-test" depends="check-simian,conf-skip-similarity-test,conf-do-similarity-test"/>



  <!-- = Configuration unit testing ========================== -->
  <!-- ======================================================= -->

  <target name="conf-skip-unit-test" unless="junit.available">
    <echo>JUnit not available, skipping Configuration API test cases...</echo>
  </target>

  <target name="conf-do-unit-test" if="junit.available">
    <echo>Running Configuration API test cases...</echo>
    <mkdir dir="${conf.junit.reports}"/>
    <junit printsummary="yes" haltonfailure="yes">
      <formatter type="plain"/>
      <classpath>
        <pathelement location="${conf.classes.normal}"/>
        <fileset dir="${lib}">
          <include name="**/*.jar"/>
        </fileset>
      </classpath>
      <batchtest fork="yes" todir="${conf.junit.reports}">
        <fileset dir="${conf.classes.normal}">
          <include name="**/*Test.class"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="conf-unit-test" depends="conf-jar,check-junit,conf-skip-unit-test,conf-do-unit-test"/>



  <!-- = Conf API documentation ============================== -->
  <!-- ======================================================= -->
  <!-- The following targets are used to generate the          -->
  <!-- muCommander conf API documentation.                     -->

  <!-- Generates the conf API documentation.                   -->
  <!-- Output will be stored in ${conf.doc}.                   -->
  <target name="conf-doc">
    <echo>Creating the Configuration API documentation...</echo>
    <mkdir dir="${conf.doc}"/>
    <javadoc destdir="${conf.doc}" author="true" windowtitle="muCommander Configuration API" encoding="UTF-8" access="protected">
      <fileset dir="${source}/com/mucommander/conf/">
        <patternset refid="non-test-sources"/>
        <exclude name="impl/**"/>
      </fileset>
      <fileset dir="${source}/com/mucommander/xml/">
        <patternset refid="non-test-sources"/>
      </fileset>
    </javadoc>
  </target>

  <target name="conf-doc-tgz" depends="conf-doc,conf-prefixes">
    <echo>Packaging the Configuration API documentation...</echo>
    <mkdir dir="${dist}"/>
    <tar destfile="${dist}/${conf.package-prefix}-docs.tar.gz" compression="gzip">
      <tarfileset dir="${conf.doc}" prefix="${conf.archive-prefix}"/>
    </tar>
  </target>


  <!-- = Findbugs integration ================================ -->
  <!-- ======================================================= -->
  <!-- Notifies user that bytecode analysis is being skipped   -->
  <!-- if FindBugs is not available.                           -->
  <target name="conf-skip-findbugs" unless="findbugs.available">
    <echo>FindBugs not available, skipping the Configuration API bytecode analysis...</echo>
  </target>

  <!-- Runs FindBugs bytecode analysis and stores the output   -->
  <!-- ${tmp.compile}/findbugs.xml.                            -->
  <target name="conf-do-findbugs" depends="conf-jar" if="findbugs.available">
    <echo>Analysing the Configuration API bytecode...</echo>
    <mkdir dir="${conf.reports}"/>
    <echo file="${conf.tmp}/findbugs-filter.xml">
&lt;FindBugsFilter&gt;
  &lt;Match&gt;
    &lt;Package name="~com\.mucommander.*" /&gt;
  &lt;/Match&gt;
&lt;/FindBugsFilter&gt;
    </echo>

    <findbugs home="${findbugs.home}" output="xml" outputFile="${conf.findbugs.reports}" jvmargs="-Xmx128m" effort="max"
              includefilter="${conf.tmp}/findbugs-filter.xml">
      <sourcePath path="${source}" />
      <class location="${conf.jar.normal}"/>
      <auxclasspath>
        <fileset dir="${lib}/noinclude">
          <include name="**/*.jar"/>
        </fileset>
      </auxclasspath>
    </findbugs>
  </target>

  <!-- Runs FindBugs bytecode analysis if it's available.      -->
  <target name="conf-findbugs" depends="load-findbugs,conf-skip-findbugs,conf-do-findbugs"/>



  <!-- = Conf API release ==================================== -->
  <!-- ======================================================= -->
  <!-- The following targets are used to generate a release    -->
  <!-- of the muCommander Configuration API.                   -->

  <target name="normal-load-strreplace" unless="conf.standalone">
    <antcall target="load-strreplace"/>
  </target>

  <target name="conf-load-strreplace" depends="normal-load-strreplace">
    <taskdef name="strreplace" classname="com.mucommander.ant.util.ReplaceTask" classpath="${tools.jar.cmp}"/>
  </target>

  <!-- TODO: I'm not very happy with this target that mirrors  -->
  <!-- "load-libpath", there should be a more elegant solution -->
  <!-- to this problem.                                        -->
  <target name="normal-load-libpath" unless="conf.standalone">
    <antcall target="tools-jar" inheritall="false"/>
    <condition property="libpath.path" value="${tools.jar.cmp}">
      <available file="${tools.jar.cmp}"/>
    </condition>
    <property name="libpath.path" value="${tools.jar.normal}"/>

    <taskdef name="libpath" classname="com.mucommander.ant.util.SystemClasspathTask" classpath="${libpath.path}"/>

    <libpath out="java.lib"/>
  </target>

  <target name="conf-standalone-load-libpath" if="conf.standalone">
    <taskdef name="libpath" classname="com.mucommander.ant.util.SystemClasspathTask" classpath="${tools.jar.cmp}"/>
    <libpath out="java.lib"/>
  </target>
  
  <target name="conf-load-libpath" depends="normal-load-libpath,conf-standalone-load-libpath"/>

  <!-- Stores the conf package and archive prefixes in         -->
  <!-- ${conf.package-prefix} and ${conf.archive-prefix}.      -->
  <!-- The archive prefix is meant to be used as the name of   -->
  <!-- the root directory in the conf tar.gz release file.     -->
  <!-- The package prefix is meant to be used as the name of   -->
  <!-- the tar.gz release file.                                -->
  <target name="conf-prefixes" depends="conf-load-strreplace">
    <echo>Creating the Configuration API archive prefix...</echo>
    <strreplace from="muCommander-conf-${conf.version}${conf.subversion}" to="conf.archive-prefix" what="[ .]" with="_"/>
    <echo>Creating the Configuration API package name prefix...</echo>
    <strreplace from="mucommander-conf-${conf.version}${conf.subversion}" to="conf.package-prefix" what="[ .]" with="_"/>
  </target>

  <target name="conf-release" depends="conf-unit-test,conf-compress,conf-prefixes,conf-doc-tgz">
    <!-- Refreshes the release directory structure.            -->
    <delete dir="${conf.tmp}/release"/>
    <mkdir dir="${conf.tmp}/release/lib"/>
    <mkdir dir="${conf.tmp}/release/lib/noinclude"/>
    <mkdir dir="${conf.tmp}/release/docs"/>
    <mkdir dir="${conf.tmp}/release/source"/>
    <mkdir dir="${conf.tmp}/release/tools"/>

    <!-- Adds the license, readme and compile files.           -->
    <copy file="${conf.license}" todir="${conf.tmp}/release"/>
    <copy file="${conf.readme}"  todir="${conf.tmp}/release"/>
    <copy file="${conf.compile}" todir="${conf.tmp}/release"/>

    <!-- Adds the compressed JAR file.                         -->
    <copy file="${conf.jar.cmp}" todir="${conf.tmp}/release/lib"/>

    <!-- Adds the JUnit JAR file.                              -->
    <copy file="${lib}/noinclude/junit.jar" todir="${conf.tmp}/release/lib/noinclude"/>

    <!-- Adds the build files.                                 -->
    <copy file="${conf.build}" tofile="${conf.tmp}/release/build.xml"/>
    <copy todir="${conf.tmp}/release/build">
      <fileset dir="build">
        <include name="common.xml"/>
        <include name="local_template.xml"/>
        <include name="conf/structure.xml"/>
        <include name="conf/main.xml"/>
      </fileset>
    </copy>

    <!-- Adds various necessary tools.                         -->
    <copy todir="${conf.tmp}/release/tools">
      <fileset dir="${tools}/">
        <include name="proguard.jar"/>
        <include name="simian.jar"/>
        <include name="mucommander-ant-tools.jar"/>
      </fileset>
    </copy>

    <!-- Adds the sources.                                     -->
    <copy todir="${conf.tmp}/release/source">
      <fileset dir="${source}/">
        <patternset refid="conf.sources"/>
      </fileset>
    </copy>

    <!-- Adds the documentation.                               -->
    <copy todir="${conf.tmp}/release/docs">
      <fileset dir="${conf.doc}/"/>
    </copy>

    <!-- Creates the the release file.                         -->
    <echo>Packaging the Configuration API release file...</echo>
    <mkdir dir="${dist}"/>
    <tar destfile="${dist}/${conf.package-prefix}.tar.gz" compression="gzip">
      <tarfileset dir="${conf.tmp}/release/" prefix="${conf.archive-prefix}">
        <include name="**"/>
      </tarfileset>
    </tar>
  </target>
</project>
